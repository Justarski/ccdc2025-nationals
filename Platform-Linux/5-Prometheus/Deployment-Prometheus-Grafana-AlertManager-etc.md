
What is deployed with this setup
- **Prometheus**
- **Grafana**
- **Alertmanager**
- **Prometheus Operator**
- **Node Exporter**
- **Kube State Metrics**


# Steps 

## 1. Clone git repo
`git clone https://github.com/prometheus-operator/kube-prometheus.git`

`cd kube-prometheus`


## 2. Apply server side manifest files
`sudo kubectl apply -n <namespace> --server-side -f manifests/setup/ ``

## 3. Wait for CRD to established
`kubectl wait --for=condition=Established --all CustomResourceDefinition --namespace=monitoring`

- Results (should see a bunch of "condition met" responses )
```sh
...
...
customresourcedefinition.apiextensions.k8s.io/volumesnapshotclasses.snapshot.storage.k8s.io condition met
customresourcedefinition.apiextensions.k8s.io/volumesnapshotcontents.snapshot.storage.k8s.io condition met
customresourcedefinition.apiextensions.k8s.io/volumesnapshots.snapshot.storage.k8s.io condition met
```


## 4.Apply the manifests
`kubectl apply -f manifests/ -n monitoring`
- The namespace is required b/c it is defined in the manifests.

## 5.Verify the deployment

```sh
kubectl get pods -n monitoring
kubectl get svc -n monitoring
```




# Accessing Grafana

## 1. Port Forward
`kubectl port-forward -n monitoring svc/grafana 3000:3000`

## 2. Recover & change Grafana password

### Create the secret
```sh
kubectl create secret generic grafana-admin-password \
    --from-literal=admin-password=<yourpassword> \
    -n monitoring
```
### Update the grafana deployment

`kubectl edit deployment grafana -n monitoring`

Add the following below under the `containers` section (within the `spec.template.spec.containers` list):
- Place this on the same level as the" ports:" tag
```

env:
- name: GF_SECURITY_ADMIN_PASSWORD
  valueFrom:
    secretKeyRef:
      name: grafana-admin-password
      key: admin-password

```

#### Conditional use: if grafana secrets are preset
(`kubectl get secret -n monitoring grafana -o jsonpath="{.data.admin-password}" | base64 --decode`
This would work if the secret was already placed in the deployment file. This is not the case, so move to "Recover and change Grafana password" )


## Restart Grafana deployment

```sh
kubectl rollout restart deployment grafana -n monitoring
```

```sh
kubectl get secret -n monitoring grafana -o jsonpath="{.data.admin-password}" | base64 --decode`
```



----
# Minimum files for deployment

Setup CRD (CustomResourceDefinitions)
a) Required to create CustomResourceDefinitions for Prometheus Operator, Alertmanager, etc.
Files:
- `manifests/setup/0namespace-namespace.yaml`
- `manifests/setup/prometheus-operator-*.yaml`

b) Prometheus Operator
Deploy the Prometheus Operator to manage Prometheus, Alertmanager, and related resources.
Files:
- `manifests/prometheus-operator-deployment.yaml`
- `manifests/prometheus-operator-service.yaml`

c) Prometheus
Deploy Prometheus and configure scraping.
Files:
- `manifests/prometheus-prometheus.yaml`
- `manifests/prometheus-service.yaml`

d) Alertmanager
Deploy Alertmanager for handling alerts generated by Prometheus.
Files:
- `manifests/alertmanager-alertmanager.yaml`
- `manifests/alertmanager-service.yaml`


e) Grafana
Deploy Grafana for visualization.
Files:
- `manifests/grafana-deployment.yaml`
-  `manifests/grafana-service.yaml`
- `manifests/grafana-dashboards/* (Optional dashboards)`

f) Node Exporter and Kube State Metrics (Optional but Recommended)
To monitor Kubernetes nodes and cluster state:
Files:
- `manifests/node-exporter-daemonset.yaml`
- `manifests/kube-state-metrics-deployment.yaml`



## 1. Minimal deployment example
You can remove optional components like Node Exporter, Kube State Metrics, or example dashboards if you only want the core functionality of Prometheus and Grafana.

Create the following minimal set of manifests:
- `prometheus-deployment.yaml`
- `grafana-deployment.yaml`
- `alertmanager-deployment.yaml`
- **Corresponding `Service` manifests for each component.**


## 2. Secure external access 
If you expose Prometheus or Grafana externally:

1. Use **Ingress** with TLS:
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana
  namespace: monitoring
  annotations:
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: grafana-auth
spec:
  tls:
  - hosts:
    - grafana.example.com
    secretName: grafana-tls
  rules:
  - host: grafana.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: grafana
            port:
              number: 80

```

Basic Auth Secret
```yaml
htpasswd -c auth admin
kubectl create secret generic grafana-auth --from-file=auth -n monitoring

```



# TLDR
### **Summary**
For a minimal, secure deployment of Prometheus and Grafana:
- Deploy:
    - `manifests/setup/*`
    - `manifests/prometheus-prometheus.yaml`
    - `manifests/alertmanager-alertmanager.yaml`
    - `manifests/grafana-deployment.yaml`
- Enable:
    - TLS for external access.
    - Authentication for Grafana (default credentials must be changed).
    - Network Policies to restrict traffic.